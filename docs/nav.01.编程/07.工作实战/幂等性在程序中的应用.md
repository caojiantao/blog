---
title: 幂等性在程序中的应用
permalink: 79397933832.html
---

## 什么是幂等？

幂等是一个数据与计算机学概念，是指一个操作，无论执行多少次产生的影响都与第一次相同。

例如Http的Get请求，就是一个幂等操作。

## 为什么需要幂等？

日常开发有几个场景会导致同一个操作多次执行；

- 依赖接口异常，触发服务端重试机制；
- MQ重复投递，产生重复消费问题；

如果没有保证上述操作的幂等性，很有可能产生重复的数据，出现未知异常。

## 怎么保证幂等？

- 根据业务唯一标识入库处理，重复数据导致唯一索引冲突；
- 利用Redis的SETNX天然幂等性操作；

## 代码示例

以商品状态变更MQ为例，当商品状态发生变更时，需要给用户发送消息提醒，并且更新活动商品状态；

### Redis SETNX

```java
@Slf4j
@Component
@RocketMQMessageListener(consumerGroup = "productConsumer", topic = "product", selectorExpression = "updateStatus")
public class ProductListener implements RocketMQListener<MessageExt> {

    @Autowired
    @Qualifier("stringRedisTemplate")
    private StringRedisTemplate stringRedisTemplate;

    @Override
    public void onMessage(MessageExt message) {
        String msgId = message.getMsgId();
        if (!stringRedisTemplate.opsForValue().setIfPresent(msgId, "1")) {
            // 已经处理过
            return;
        }
        // 商品状态变更处理：发送用户消息、活动商品处理等等
    }
}
```

### AOP优化

自定义幂等性校验注解；

```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Idempotent {

    long timeout();
}
```

编写AOP切面统一处理；

```java
@Slf4j
@Aspect
@Component
public class IdempotentAspect {

    @Autowired
    @Qualifier("stringRedisTemplate")
    private StringRedisTemplate stringRedisTemplate;

    @Around("@annotation(com.caojiantao.study.Idempotent)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        // 拿到关联注解
        MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature();
        Idempotent annotation = methodSignature.getMethod().getAnnotation(Idempotent.class);
        long timeout = annotation.timeout();
        Object[] args = joinPoint.getArgs();
        MessageExt messageExt = (MessageExt) args[0];
        String msgId = messageExt.getMsgId();
        if (!stringRedisTemplate.opsForValue().setIfPresent(msgId, "1", Duration.of(timeout, ChronoUnit.MILLIS))) {
            // 已经处理过
            return true;
        }
        return joinPoint.proceed();
    }
}
```